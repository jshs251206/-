<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>í˜ˆêµ¬ ìë™ ê°œìˆ˜ ì„¸ê¸°</title>

  <!-- OpenCV.js -->
  <script async src="https://docs.opencv.org/4.x/opencv.js"></script>

  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
    }
    canvas {
      border: 1px solid #333;
      margin-top: 10px;
      max-width: 100%;
    }
  </style>
</head>

<body>

<h2>ğŸ”¬ í˜ˆêµ¬ ìë™ ê°œìˆ˜ ì„¸ê¸°</h2>
<input type="file" id="imageInput" accept="image/*">
<p id="status">ì´ë¯¸ì§€ë¥¼ ì—…ë¡œë“œí•˜ì„¸ìš”.</p>
<canvas id="canvas"></canvas>
<h3 id="result"></h3>

<script>
cv['onRuntimeInitialized'] = () => {

  let img = new Image();
  let input = document.getElementById("imageInput");

  input.addEventListener("change", e => {
    img.src = URL.createObjectURL(e.target.files[0]);
  });

  img.onload = () => {
    document.getElementById("status").innerText = "ë¶„ì„ ì¤‘...";

    const canvas = document.getElementById("canvas");
    canvas.width = img.width;
    canvas.height = img.height;
    const ctx = canvas.getContext("2d");
    ctx.drawImage(img, 0, 0);

    // ===== OpenCV ì²˜ë¦¬ ì‹œì‘ =====
    let src = cv.imread(canvas);
    let gray = new cv.Mat();
    let blur = new cv.Mat();
    let thresh = new cv.Mat();
    let contours = new cv.MatVector();
    let hierarchy = new cv.Mat();

    // 1ï¸âƒ£ Grayscale
    cv.cvtColor(src, gray, cv.COLOR_RGBA2GRAY);

    // 2ï¸âƒ£ Gaussian Blur (ë…¸ì´ì¦ˆ ì œê±°)
    cv.GaussianBlur(gray, blur, new cv.Size(5, 5), 0);

    // 3ï¸âƒ£ Adaptive Threshold (ê²©ì ëŒ€ë¹„ ì•ˆì •ì )
    cv.adaptiveThreshold(
      blur,
      thresh,
      255,
      cv.ADAPTIVE_THRESH_GAUSSIAN_C,
      cv.THRESH_BINARY_INV,
      11,
      2
    );

    // 4ï¸âƒ£ Contour ê²€ì¶œ
    cv.findContours(
      thresh,
      contours,
      hierarchy,
      cv.RETR_EXTERNAL,
      cv.CHAIN_APPROX_SIMPLE
    );

    // 5ï¸âƒ£ í˜ˆêµ¬ í•„í„°ë§ (ë©´ì  + ì›í˜•ë„)
    let count = 0;

    for (let i = 0; i < contours.size(); i++) {
      let cnt = contours.get(i);

      let area = cv.contourArea(cnt);
      if (area < 80 || area > 2000) continue;

      let perimeter = cv.arcLength(cnt, true);
      if (perimeter === 0) continue;

      let circularity =
        4 * Math.PI * area / (perimeter * perimeter);

      // í˜ˆêµ¬ ì¡°ê±´
      if (circularity > 0.6) {
        count++;
        cv.drawContours(
          src,
          contours,
          i,
          new cv.Scalar(255, 0, 0, 255),
          2
        );
      }
    }

    // ê²°ê³¼ ì¶œë ¥
    cv.imshow(canvas, src);
    document.getElementById("result").innerText =
      `í˜ˆêµ¬ ê°œìˆ˜: ${count}`;
    document.getElementById("status").innerText =
      "ë¶„ì„ ì™„ë£Œ";

    // ë©”ëª¨ë¦¬ í•´ì œ
    src.delete(); gray.delete(); blur.delete();
    thresh.delete(); contours.delete(); hierarchy.delete();
  };
};
</script>

</body>
</html>
